--// ================================
--// AIRHUB WALLHACK / ESP (FIXED)
--// ================================

-- NEVER return early
getgenv().AirHub = getgenv().AirHub or {}
getgenv().AirHub.WallHack = getgenv().AirHub.WallHack or {}

local WallHack = getgenv().AirHub.WallHack
WallHack.Enabled = true

warn("WALLHACK MODULE LOADED")

--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

--// Settings
local Settings = {
    Box = true,
    Name = true,
    Health = true,
    TeamCheck = false,
    Color = Color3.fromRGB(255, 0, 255)
}

--// Drawing cache
local Drawings = {}

--// Utility
local function NewDrawing(type, props)
    local d = Drawing.new(type)
    for i, v in pairs(props) do
        d[i] = v
    end
    return d
end

--// Clean ESP
local function ClearESP(player)
    if Drawings[player] then
        for _, d in pairs(Drawings[player]) do
            d:Remove()
        end
        Drawings[player] = nil
    end
end

--// Add ESP
local function AddESP(player)
    if player == LocalPlayer then return end
    if Drawings[player] then return end

    Drawings[player] = {
        Box = NewDrawing("Square", {
            Thickness = 2,
            Color = Settings.Color,
            Transparency = 1,
            Filled = false,
            Visible = false
        }),

        Name = NewDrawing("Text", {
            Size = 14,
            Center = true,
            Outline = true,
            Color = Color3.new(1,1,1),
            Visible = false
        }),

        Health = NewDrawing("Text", {
            Size = 13,
            Center = true,
            Outline = true,
            Color = Color3.fromRGB(0,255,0),
            Visible = false
        })
    }
end

--// Update loop
RunService.RenderStepped:Connect(function()
    for player, esp in pairs(Drawings) do
        local char = player.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        local hrp = char and char:FindFirstChild("HumanoidRootPart")

        if not char or not hum or hum.Health <= 0 or not hrp then
            esp.Box.Visible = false
            esp.Name.Visible = false
            esp.Health.Visible = false
            continue
        end

        if Settings.TeamCheck and player.Team == LocalPlayer.Team then
            esp.Box.Visible = false
            esp.Name.Visible = false
            esp.Health.Visible = false
            continue
        end

        local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
        if not onScreen then
            esp.Box.Visible = false
            esp.Name.Visible = false
            esp.Health.Visible = false
            continue
        end

        local scale = 1 / (pos.Z / 600)
        local width = 40 * scale
        local height = 60 * scale

        -- Box
        esp.Box.Size = Vector2.new(width, height)
        esp.Box.Position = Vector2.new(pos.X - width / 2, pos.Y - height / 2)
        esp.Box.Visible = Settings.Box

        -- Name
        esp.Name.Text = player.Name
        esp.Name.Position = Vector2.new(pos.X, pos.Y - height / 2 - 15)
        esp.Name.Visible = Settings.Name

        -- Health
        esp.Health.Text = "HP: " .. math.floor(hum.Health)
        esp.Health.Position = Vector2.new(pos.X, pos.Y + height / 2)
        esp.Health.Visible = Settings.Health
    end
end)

--// Player handling
for _, p in ipairs(Players:GetPlayers()) do
    AddESP(p)
end

Players.PlayerAdded:Connect(AddESP)
Players.PlayerRemoving:Connect(ClearESP)

warn("WALLHACK ESP RUNNING")
